### [SimpleJavaJsBridge: 交互库，需要与服务器端共同定一个协议](http://mp.weixin.qq.com/s/8f-zHzKLprtTGreA7uRHFA)

### 官方提供Js与Java通信方案的不足

#### 1: 强依赖
>   java给js发送消息的方法，和js给java发送消息的官方方法都存在着强依赖的问题，都要高度依赖对方的方法名字，方法参数。强依赖发生于同一模块内，个人觉得不是问题甚至是高内聚的体现。但是java与js可以说是处于两个不同的模块或者叫两个不同世界，只要js提供给java的方法发生变化，java也得改动，同理java提供给js的方法也如此。处于两个不同模块知道对方的细节越少越好，这样耦合性就会降低，耦合性降低的好处就不用说了。

#### 2: 强依赖导致 js 需要兼容不同的系统
先看段伪代码
````python
function location(){
      //是ios系统，采用给ios发送消息的方法
      if(isIOS){
              给ios发送消息；
      }else if(isAndroid){
              给android发送消息；
      }
}
````
> 上面的代码展示的是js使用native的定位功能的代码，因为js在给不同的系统发送消息的方式不一样，就会出现if else if 这样的兼容语句。当前js代码只被ios和android使用，假如还会被wp或pc来使用，那if else if岂不是要恶心死。产生该问题的主要原因是：js代码在针对不同的系统自己独有的通信方式进行通信。

#### 3: 给不存在的接口发消息没反馈
> java在给js的一个不存在接口发送消息时，java根本不知道该接口不存在，java只会傻傻的等待。同理js在给java的一个不存在接口发送消息时，js是可以通过捕获异常来知道该接口不存在，但是这不是最好的解决方案。
给不存在接口发送消息没反馈会导致js代码充斥着if else if语句，看段伪代码：
````python
//调用java的定位方法
function location(){
     //1.1版本以上才会调用定位功能
     if(androidAppVersion > '1.1'){
             发送消息给java；
     }else{
             给用户提示，暂不支持定位功能；
     }
}
````
这是一段调用java进行定位的js代码，android app在版本1.1的时候才增加了定位的功能，因此对于1.1以下版本是不支持这功能的，因此js代码里面非常有必要根据版本号进行判断。这只是由于版本问题导致if else if的一个小小的缩影。还有一些其他情况导致if else if的产生比如一份js代码被多个业务使用。

### Js给 java 发送消息第二种方法的不足（解决Android4.4以下系统的漏洞，利用协定cmd字符串反射执行本地方法）
> 上文提到的js给java发送消息的第二种方法，它解决了存在的漏洞，但是这种方法，使用起来要比第一种方法复杂，java会多做以下工作：
- 解析js传递给java的字符串，把调用的接口，参数解析出来
- 把调用的接口，参数映射到相应的方法

不论js传递给java的字符串是json格式还是其他格式，解析这样的字符串肯定是一件无趣的重复的体力劳动。若想解决以上的问题，我们有必要设计一套完美的通信方案。


## [完美通信方案设计](http://www.jianshu.com/p/de6331c9958f)

#### 完美方案应该满足以下几点
- js与java知道对方的细节越少越好，越少它们的耦合性越低。那到底多少为好呢？我个人觉得互相暴漏给对方一个接口足矣。这样js与native的通信就类似于通过一个管道通信或者说类似于socket通信(降低强依赖)

- js与java之间通信，需要定义好一套通信协议或者叫通信规则，在管道之间传递通信协议。这样它们之间的通信是针对一套定义好的协议进行的，而不是针对每个系统自己独有的通信方式（好处js就不会出现兼容不同的系统的if else if代码）

- 主动发送消息给对方时，对方必须对该消息予以反馈，即使主动发送消息者对反馈消息不感兴趣，（反馈信息可以去掉由于版本兼容等带来的if else if兼容代码）
