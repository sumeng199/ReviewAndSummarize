## [Mars](http://www.52im.net/thread-684-1-1.html)

## 1 简介
- [项目git地址](https://github.com/Tencent/mars)
- [微信Mars：客户端跨平台组件的开发经验](https://mp.weixin.qq.com/s/obfHNHYXDZDMGrZd-TpRGA)
- [微信终端跨平台组件 mars 系列 - 我们如约而至](http://mp.weixin.qq.com/s/JVsVrKwJlOwoB3Rz0e17wQ)
- [微信终端跨平台组件 mars 系列（一） - 高性能日志模块xlog](http://mp.weixin.qq.com/s/cnhuEodJGIbdodh0IxNeXQ)
- [微信终端跨平台组件 mars 系列(二) - 信令传输超时设计](http://mp.weixin.qq.com/s/PnICVDyVuMSyvpvTrdEpSQ)
- [微信终端跨平台组件 Mars 系列（三）连接超时与IP&Port排序](http://mp.weixin.qq.com/s/LGEmNa2qxdjdhy4yY6CN2w)


解决的问题
>- 提供长连，短连两种网络通道；
>- 常规的网络能力，如 DNS 防劫持、动态 IP 下发、就近接入、容灾恢复等
>- 贴合移动互联网的网络层解决方案
>- 贴合移动终端平台特性：前后台、活跃性、休眠、省电、省流量等。

主要模块(各模块均可独立使用)
>- COMM：基础库，包括socket、线程、消息队列、协程等基础工具；
>- XLOG：通用日志模块，充分考虑移动终端的特点，提供高性能、高可用、安全性、容错性的日志功能；
>- SDT：网络诊断模块；
>- STN：信令传输网络模块，核心模块，负责终端与服务器的小数据信令通道。包含了微信终端在移动网络上的大量优化经验与成果，经历了微信海量用户的考验。

## 2 同类技术横向对比
|            | Mars   |  Retrofit  | OkHttp |
| --------   | :-----:  | :----:  | :----:|
| 跨平台     | yes |   no    | no |
| 实现语言    |  C++  |  Java  | Java |
| 具体实现    |  基于 socket  |  基于 HTTP  | 基于 HTTP |
| 支持完整的HTTP |  no  |  yes  | yes |
| 支持长连 |  yes  |  no  | no |
| 日志 |  yes  |  no  | no |
| DNS扩展 | yes   |  no  | no |
| 结合移动App做设计 |  yes  |  no  | no |

## 3 Mars设计原则
基础组件以跨平台、跨业务为前提，遵从高可用、高性能、负载均衡的设计原则。

高可用是一个即时通讯类 App 的立身之本。高可用又体现在多个层面上：网络的可用性、 App的可用性、 系统的可用性等

>- ##### 网络的可用性
>    移动互联网有着丢包率高、带宽受限、延迟波动、第三方影响等特点，使得网络的可用性，尤其是弱网络下的可用性变的尤为关键。Mars 的 STN 组件作为基于 socket 层的网络解决方案，在很多细节设计上会充分考虑弱网络下的可用性。
>- ##### App 的可用性
>    App 的可用性包含稳定性、运行性能等多方面。文章高性能日志模块 xlog 描述了 xlog 在不影响 App 运行性能的前提下进行的大量设计思考。
>- ##### 系统的可用性：
>    除了考虑正常的使用场景，App的设计还需要从整个系统的角度进行设计思考。例如在容灾设计上，Mars 不仅使用了服务器容灾方案，也设计了客户端的本地容灾。当部分服务器出灾时，目前微信可以做到，15min 内把 95% 以上的用户转移到可用服务器上。

## 4 网络基础
smc 网络统计监控组件
>- ##### 基础网络优化
>    常规的网络能力，例如 DNS 防劫持、动态 IP 下发、就近接入、容灾恢复等，在这一阶段得到逐步的建设与完善。除此之外，Mars的网络模块是基于 socket 层的网络解决方案，在缺失大而全的 HTTP 能力的同时，却可以将优化做到细致，细致到连接策略、连接超时、多级读写超时、收发策略等每个网络过程中。例如，当遇到弱网络下连通率较低，或者某些连通率不好的的服务器影响使用时，我们使用了复合连接(代码见complexconnect.cc)和 IP 排序(代码见simple_ipport_sort.cc)的方案很好的应对这两个问题。
>- ##### 平台特性优化
>    虽然 Mars 是跨平台的基础组件，但在很多设计上是需要结合各平台的特性的。例如为了尽量减少频繁的唤醒手机，引入了智能心跳（详见[《移动端IM实践：实现Android版微信的智能心跳机制》](http://mp.weixin.qq.com/s/ghnmC8709DvnhieQhkLJpA)），并且在智能心跳中考虑了 Android 的 alarm 对齐特性(具体实现见smart_heartbeat.cc)。再如在网络切换时，为了平滑切换的过程，使用了 iOS 中网络的特性，在 iOS 中做了延迟处理等。
>- ##### 移动特性优化
>    微信的使用场景大部分是在手机端进行使用，在组件的设计过程中，我们也会研究移动设备的特性，并进行结合优化。例如，结合移动设备的无线电资源控制器（RRC）的状态切换，对一些性能要求特别特别敏感的请求，进行提前激活的优化处理等。
